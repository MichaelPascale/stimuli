<!DOCTYPE html>
<html>
    <!-- PCRM Blur-Level Norming Online Study 
         Copyright (c) 2025, Michael Pascale <mpascale@bu.edu>. MIT Licensed. -->
    <head>
        <style>
            :root {
                --pcrm-stim-width: 100mm;
                --pcrm-menu-height: 10mm;

                --pcrm-interface-color-fg: grey;
                --pcrm-interface-color-bg: white;
                --pcrm-interface-color-text: black;

                --pcrm-interface-font: Arial, monospace;
            }

            body {
                background-color: var(--pcrm-interface-color-bg);
                font-family: var(--pcrm-interface-font);
                font-size: 5mm;
            }

            .presentation {
                position:   absolute;
                margin:     auto;
                left:       0;
                right:      0;
                top:        0;
                bottom:     0;
                width:      var(--pcrm-stim-width);
                height:     var(--pcrm-stim-width);
                /* border:     1mm solid var(--pcrm-interface-color-fg); */
            }

            .stim {
                width: 100%;
                height: 100%;
                /* Blur wiill be changed programmatically */
                filter: blur(40px);
            }

            .message-text {
                width: 100%;
                height: 100%;
                text-align: center;
                align-content: center;
                display: block;
                position: absolute;
                z-index: 1;
                top: 0;
            }

            .menu {
                position: absolute;
                bottom: -30mm;
                width: var(--pcrm-stim-width);
                height: var(--pcrm-menu-height);
                display: flex;
                align-items: center;
                justify-content: space-evenly;
            }
            
            button {
                font-family: inherit;
                font-size: inherit;
            }   

            .developer-controls {
                position: absolute;
                bottom: 1px;
                right:1px;
                font-size: 3mm;
            }
        </style>
        <script>
            var img_stim;
            var menus = {};
            var dev_readout;
            var message_readout;

            var query = new URLSearchParams(window.location.search);

            var maxBlur = 60; // px
            var stepBlur = 4; 
            var idx_stim  = query.get('item') || 0;
            var idx_level = 0;

            var datalog  = {
                "version": "0.0.1",
                "date": (new Date()).toISOString(),
                "userAgent": navigator.userAgent,
                "displayProperties": {
                    "devicePixelRatio": window.devicePixelRatio,
                    "width": window.screen.width,
                    "height": window.screen.height,
                    "colorDepth": window.screen.colorDepth,
                    "orientation": window.screen.orientation.type,
                    "innerWidth": window.innerWidth,
                    "innerHeight": window.innerHeight
                },
                "experiment": {
                    "task": "pcrm/things/images_THINGSplus-CC0/gt75sdlt25-num",
                    "maxBlur": maxBlur,
                    "stepBlur": stepBlur,
                },
                "events": []
            };

            function stim_advance() {
                if (idx_level > 15) {
                    stim_next();
                    return;
                }
                // Calculate the radius for the Gaussian blur.
                sd = maxBlur - idx_level * stepBlur;
                filter = `blur(${sd}px)`;

                log('advance:' + filter);
                
                img_stim.style.filter = filter;
                idx_level++;
            };

            async function stim_next() {
                idx_stim++;
                idx_level=0;
                file = `/things/images_THINGSplus-CC0/gt75sdlt25-num/${String(idx_stim).padStart(3,0)}.jpg`;
                dev_readout.innerText = idx_stim;
                log(`image:${idx_stim}`)
                removeEventListener("keydown", listener_keydown);
                
                // Hide the menu while the image is loading.
                menu_show(null);
                display_toggle(img_stim);
                display_toggle(message_readout);

                if (img_stim.src) {
                    const prev = img_stim.src;
                    img_stim.src = '';
                    URL.revokeObjectURL(prev);
                }


                const res_promise = fetch(file);

                setTimeout(async ()=>{
                    const res = await res_promise;
                    
                    if (!res.ok) throw new Error(res.statusText);

                    const blob = await res.blob();
                    const objectURL = URL.createObjectURL(blob);

                    img_stim.src=objectURL;

                    menu_show('sel')
                    display_toggle(img_stim);
                    display_toggle(message_readout);

                    addEventListener("keydown", listener_keydown);

                    stim_advance();

                }, 1250);
            };

            async function fetch_stim(num) {

                

            };

            function stim_check() {
                log('check');
                removeEventListener("keydown", listener_keydown);
                menu_show('chk');
                img_stim.style.filter='blur(0)';
            };

            function menu_show(menu) {
                Object.entries(menus).forEach(([name, el]) => {
                    if (name == menu)
                        el.style.display = 'flex';
                    else
                        el.style.display = 'none';
                });
            };

            function display_toggle(el, set, initial) {
                if (set) {
                    el.style.display = set;
                    return;
                }

                if (el.style.display == 'none')
                    el.style.display = initial || 'unset';
                else
                    el.style.display = 'none';
            }

            function log(event) {
                const timestamp = (new Date()).toISOString();
                datalog["events"].push({"time": timestamp, "event": event});
            };

            function download() {
                const blob = new Blob([JSON.stringify(datalog)], {
                type: "application/json",
                });
               
                const node = document.createElement('a');
                node.href =  URL.createObjectURL(blob);
                node.download = `PCRMNorm_${datalog.date.replaceAll(':', '').substring(0,17)}.json`;
                node.display = 'none';
                document.body.appendChild(node);
                node.click();
                URL.revokeObjectURL(node.href);
                node.remove();
                
            };

            function listener_keydown(ev) {
                log(`keydown:${ev.key}`);
                if (ev.key == 'k')
                    stim_advance()
                else if (ev.key == 's')
                    stim_check()
            }

            addEventListener("DOMContentLoaded", function (ev) {

                img_stim     = document.getElementById("stim");

                menus['sel'] = document.getElementById("menu-select");
                menus['chk'] = document.getElementById("menu-check");
                menus['nam'] = document.getElementById("menu-name")

                message_readout = document.getElementById("message");
                display_toggle(message_readout);

                dev_readout  = document.getElementById("developer-image-idx");
                

                Object.values(menus).forEach(el => el.style.display = 'none');
                
                alert("As soon as you feel that you can identify the object in the image, even if not by name, click \"I know it!\". Then, the clarified image will be shown. Determine whether you were correct.\n\nWhen you are complete, note the image number and click the Download Data button.\n\nYou can return to where you left off by appending \"?item=\" and the image number to the URL.");

                stim_next();
            });
        </script>
    </head>
    <body>
           <div class="presentation">

            
            <!-- The stimulus image -->
            <img id="stim" class="stim">
            <div id="message" class="message-text"></div>
            
            <!-- Select the object -->
            <div id="menu-select" class="menu">
                <button onclick="stim_check()">I know it! (s)</button>
                <button onclick="stim_advance()">Not sure (k)</button>
            </div>

            <!-- Determine if guess was correct (clarified) -->
            <div id="menu-check" class="menu">
                Were you correct? <button onclick="log('correct');stim_next();"></buttononclick>Yes</button>
                <button onclick="log('incorrect');stim_next();">No</button>
            </div>
            
            <!-- Name the object -->
            <div id="menu-name" class="menu">
                <button>Cancel</button>
                <input type="text" placeholder="It's a... (answer here)">
                <button>Submit</button>
            </div>
        </div>
        <div class="developer-controls">
            Image <span id="developer-image-idx"></span>
            <button onclick="download()">Download Results</button>
            <a href="mailto:mpascale@bu.edu?subject=pcrm_v0.0.2&body=Attach the JSON data file.">Email Your Results</a>
        </div>
    </body>
</html>